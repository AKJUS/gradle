// Copyright (C) 2024 Gradle, Inc.
//
// Licensed under the Creative Commons Attribution-Noncommercial-ShareAlike 4.0 International License.;
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      https://creativecommons.org/licenses/by-nc-sa/4.0/
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

[[part8_add_build_listener]]
= Part 8: Add a Build Listener

Learn the basics of the Build Listerner API.

****
**In this section, you will:**

- Understand Build Listeners
- Add a Build Listener to the Plugin
****

[[part8_begin]]
== Step 0. Before you Begin

1. You initialized your plugin in <<part1_gradle_init_plugin.adoc#part1_begin,part 1>>.
2. You added an extension to your plugin in <<part2_add_extension.adoc#part2_begin,part 2>>.
3. You created a custom task in <<part3_create_custom_task.adoc#part3_begin, part3>>.
4. You wrote a unit test in <<part4_unit_test.adoc#part4_begin,part 4>>.
5. You added a dataflow action to your plugin in <<part5_add_dataflow_action.adoc#part5_begin,part 2>>.
6. You wrote a functional test in <<part6_functional_test.adoc#part6_begin,part 6>>.
7. You used a dummy consumer project to consume your plugin in <<part7_use_consumer_project.adoc#part7_begin,part 7>>.

== Step 1. Understanding Build Listeners

`BuildListener` is a Gradle interface that lets you hook into the build lifecycle.
By implementing it, you can execute code at specific points in a Gradle build, such as when it starts, when settings are evaluated, and most commonly, when the build finishes.

A `BuildListener` is useful to run some logic at the end (or during key points) of the build.
For example:

* Sending a Slack notification after the build finishes
* Logging diagnostics or analytics
* Performing cleanup tasks

The interface is designed as follows:

[source,kotlin]
----
interface BuildListener {
    fun settingsEvaluated(settings: Settings) {}
    fun projectsLoaded(gradle: Gradle) {}
    fun projectsEvaluated(gradle: Gradle) {}
    fun buildFinished(result: BuildResult) {}
}
----

All methods are optional, you only need to override what you care about.

For our plugin, we will only need to override the `buildFinished` method.

== Step 2. Adding a Listener to our Plugin

We will take a simple approach first and implement the interface and Slack logic in the plugin's `apply()` method:

Update your plugin so it looks as follows:

[source,kotlin]
----
import com.slack.api.Slack
import com.slack.api.methods.request.chat.ChatPostMessageRequest

import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.initialization.Settings
import org.gradle.api.invocation.Gradle
import org.gradle.BuildListener
import org.gradle.BuildResult

abstract class SlackPlugin : Plugin<Project> {
    override fun apply(project: Project) {
        // Create the 'slack' extension so users can configure token, channel, and message
        val extension = project.extensions.create("slack", SlackExtension::class.java)

        // Register a task named 'sendTestSlackMessage' of type SlackTask
        val taskProvider: TaskProvider<SlackTask> = project.tasks.register("sendTestSlackMessage", SlackTask::class.java)

        // Configure the task using values from the extension
        taskProvider.configure {
            it.group = "notification" // Logical task grouping for help output
            it.description = "Sends a test message to Slack using the configured token and channel."

            // Bind extension values to the task's input properties
            it.token.set(extension.token)
            it.channel.set(extension.channel)
            it.message.set(extension.message)
        }

        // Attach a BuildListener to react to the build lifecycle
        project.gradle.addBuildListener(object : BuildListener {
            override fun settingsEvaluated(settings: Settings) {}
            override fun projectsLoaded(gradle: Gradle) {}
            override fun projectsEvaluated(gradle: Gradle) {}
            override fun buildFinished(result: BuildResult) {
                val token = extension.token.orNull
                val channel = extension.channel.orNull

                if (token.isNullOrBlank() || channel.isNullOrBlank()) {
                    println("SlackPlugin not configured: token or channel missing.")
                    return
                }

                val message = if (result.failure != null) {
                    "Gradle build failed."
                } else {
                    "Gradle build succeeded."
                }

                try {
                    val slack = Slack.getInstance()
                    val methods = slack.methods(token)
                    val request = ChatPostMessageRequest.builder()
                        .channel(channel)
                        .text(message)
                        .build()
                    val response = methods.chatPostMessage(request)
                    if (response.isOk) {
                        println("Slack message sent to $channel: $message")
                    } else {
                        println("Slack message failed: ${response.error}")
                    }
                } catch (e: Exception) {
                    println("Error sending Slack message: ${e.message}")
                }
            }
        })
    }
}
----

Now we have a simple but working plugin that send a Slack message when the build finished using a `BuildListener`.
You could clean this up a little bit by extracting the Slack code into its own function or its own class.

However, the reason we didn't use a Build Listener previously is that the `buildFinished` method is NOT Configuration Cache compatible.
See the Configuration Cache <<configuration_cache_requirements.adoc#config_cache:requirements:build_listeners, documentation>> to learn more.

[.text-right]
**Next Step:** <<part9_add_build_service.adoc#part9_add_build_service,Add a Build Service>> >>
