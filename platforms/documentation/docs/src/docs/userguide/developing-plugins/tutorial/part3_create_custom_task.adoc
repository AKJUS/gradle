// Copyright (C) 2024 Gradle, Inc.
//
// Licensed under the Creative Commons Attribution-Noncommercial-ShareAlike 4.0 International License.;
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      https://creativecommons.org/licenses/by-nc-sa/4.0/
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

[[part3_create_custom_task]]
= Part 3: Creating Tasks

Learn about tasks in plugins

****
**In this section, you will:**

- Understand Custom Tasks in Plugins
- Add a Custom Task to the Slack Plugin
****

[[part3_begin]]
== Step 0. Before you Begin

1. You initialized your plugin in <<part1_gradle_init_plugin.adoc#part1_begin,part 1>>.
2. You added an extension to your plugin in <<part2_add_extension.adoc#part2_begin,part 2>>.

== Step 1. About Custom Tasks

To make your plugin actually do something, youâ€™ll need to define a custom task.

In this case, the task will send a message to Slack using the configuration provided by the user.

== Step 2. Create a Custom Task

Create a new Kotlin file (e.g. `SlackTask.kt`) in `src/main/kotlin/org/example/` and add the following code:

[source,kotlin]
----
package org.example

import com.slack.api.Slack
import com.slack.api.methods.request.chat.ChatPostMessageRequest

import org.gradle.api.DefaultTask
import org.gradle.api.provider.Property
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.TaskAction
import kotlin.text.isNotEmpty

/**
 * A custom Gradle task that sends a test message to a Slack channel.
 *
 * This task is useful for verifying Slack integration during build configuration.
 * It uses the Slack Web API and requires a bot token and a target channel.
 */
abstract class SlackTask : DefaultTask() {

    // The Slack bot token (usually starts with "xoxb-") used to authenticate the API request.
    @get:Input
    abstract val token: Property<String>

    // The Slack channel name or ID (e.g., "#builds" or "C12345678") where the message will be sent.
    @get:Input
    abstract val channel: Property<String>

    // The message content to be sent to the specified Slack channel.
    @get:Input
    abstract val message: Property<String>

    /**
     * Sends a message to Slack when the task is executed.
     * Useful for manual testing of Slack integration from the command line.
     */
    @TaskAction
    fun send() {
        // Initialize the Slack client and get the API methods interface
        val slack = Slack.getInstance()
        val methods = slack.methods(token.get())

        // Extra debug statements
        logger.debug("Preparing to send Slack message...")
        logger.debug("Token present: ${token.get().isNotEmpty()}")
        logger.debug("Channel: ${channel.get()}")

        // Create a Slack message request
        val request = ChatPostMessageRequest.builder()
            .channel(channel.get())
            .text(message.get())
            .build()

        // Extra debug statements
        logger.debug("Sending message to Slack...")

        // Send the message via the Slack API and check for success
        val response = methods.chatPostMessage(request)
        if (response.isOk) {
            logger.lifecycle("Slack message sent successfully to channel ${channel.get()}")
        } else {
            // Fail the build if the Slack API response indicates an error
            logger.error("Failed to send Slack message: ${response.error}")
            throw RuntimeException("Slack message failed: ${response.error}")
        }
    }
}
----

This task:

* Declares three input properties: `token`, `channel`, and `message`.
* In the `@TaskAction`, it uses the link:https://github.com/slackapi/java-slack-sdk[Slack API client] to post a message.
* If the message is sent successfully, it prints a confirmation to the console.
* If something goes wrong, the task fails the build with a clear error message.

The Slack API client is a dependency so you need to add it in your build file:

[source,kotlin]
----
dependencies {
    // Use the Java Slack Client APIs
    implementation("com.slack.api:slack-api-client:1.45.3")
}
----

== Step 3. Register it in the Plugin

Now that you've defined a custom task class (`SlackTask`), you need to register it in your plugin so users can run `./gradlew sendSlackMessage` from their project.

Open your plugin implementation file, `SlackPlugin.kt` (in `src/main/kotlin/org/example/`), and modify or confirm it looks like this:

[source,kotlin]
----
abstract class SlackPlugin : Plugin<Project> {
    override fun apply(project: Project) {
        // Create the 'slack' extension so users can configure token, channel, and message
        val extension = project.extensions.create("slack", SlackExtension::class.java)

        // Register a task named 'sendTestSlackMessage' of type SlackTask
        val taskProvider: TaskProvider<SlackTask> = project.tasks.register("sendTestSlackMessage", SlackTask::class.java)

        // Configure the task using values from the extension
        taskProvider.configure {
            it.group = "notification" // Logical task grouping for help output
            it.description = "Sends a test message to Slack using the configured token and channel."

            // Bind extension values to the task's input properties
            it.token.set(extension.token)
            it.channel.set(extension.channel)
            it.message.set(extension.message)
        }
    }
}
----

What this does:

* Registers a user-facing configuration block (`slack {}`) via the `SlackExtension` class.
* Registers a task named `sendSlackMessage` of type `SlackTask`.
* Binds the task's `token`, `channel`, and `message` properties to the values defined by the user in the build script.

[.text-right]
**Next Step:** <<part4_build_listener#part4_build_listerner,Add a BuildListener>> >>
